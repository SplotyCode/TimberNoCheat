package me.david.TimberNoCheat.checkes.exploits;

import com.comphenix.protocol.events.PacketContainer;
import com.comphenix.protocol.events.PacketEvent;
import com.google.common.base.Charsets;
import io.netty.buffer.ByteBuf;
import me.david.TimberNoCheat.TimberNoCheat;
import me.david.TimberNoCheat.checkmanager.Category;
import me.david.TimberNoCheat.checkmanager.Check;

import java.io.IOException;

public class Channels extends Check {

    public Channels(){
        super("Channels", Category.EXPLOITS);
    }

    /*
    check is registet in NBT class
     */
    public static void check(PacketEvent event){
        int channelsSize = event.getPlayer().getListeningPluginChannels().size();
        PacketContainer container = event.getPacket();
        ByteBuf buffer = container.getSpecificModifier(ByteBuf.class).read(0).copy();
        try {
            for (int i = 0; i < buffer.toString(Charsets.UTF_8).split("\0").length; i++)
                if (++channelsSize > TimberNoCheat.instance.settings.exploit_nbtchannel_toomany){
                    TimberNoCheat.checkmanager.notify(TimberNoCheat.checkmanager.getCheckbyName("Channels"), event.getPlayer(), " §6CHANELLSIZE: §b" + channelsSize, " §6KICK: §b" + !TimberNoCheat.instance.settings.exploit_nbtchannel_cmd.equals(""));
                    TimberNoCheat.checkmanager.execute(TimberNoCheat.instance.settings.exploit_nbtchannel_cmd, event.getPlayer().getName());
                    event.setCancelled(true);
                    return;
                }
        } finally {
            buffer.release();
        }
    }
}
