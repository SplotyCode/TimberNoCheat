package me.david.TimberNoCheat.checkes.exploits;

import com.comphenix.protocol.PacketType;
import com.comphenix.protocol.events.PacketAdapter;
import com.comphenix.protocol.events.PacketContainer;
import com.comphenix.protocol.events.PacketEvent;
import com.comphenix.protocol.utility.StreamSerializer;
import com.comphenix.protocol.wrappers.nbt.NbtCompound;
import com.comphenix.protocol.wrappers.nbt.NbtFactory;
import com.comphenix.protocol.wrappers.nbt.NbtList;
import io.netty.buffer.ByteBuf;
import me.david.TimberNoCheat.TimberNoCheat;
import me.david.TimberNoCheat.checkmanager.Category;
import me.david.TimberNoCheat.checkmanager.Check;
import org.bukkit.inventory.ItemStack;

import java.io.ByteArrayInputStream;
import java.io.DataInputStream;
import java.io.IOException;

public class NBT extends Check {

    public NBT(){
        super("NBT", Category.EXPLOITS);
        TimberNoCheat.instance.protocolmanager.addPacketListener(new PacketAdapter(TimberNoCheat.instance, PacketType.Play.Client.CUSTOM_PAYLOAD) {
            @Override
            public void onPacketReceiving(PacketEvent event) {
                if(!TimberNoCheat.checkmanager.isvalid_create(event.getPlayer())){
                    return;
                }
                String name = event.getPacket().getStrings().readSafely(0);
                if(name.equals("REGISTER")){
                    Channels.check(event);
                }
                if (!"MC|BSign".equals(name) && !"MC|BEdit".equals(name))
                    return;
                check(event);
                Packet_Flood.check(event);
            }
        });
    }
    public void check(PacketEvent event){
        PacketContainer container = event.getPacket();
        ByteBuf buffer = container.getSpecificModifier(ByteBuf.class).read(0).copy();

        byte[] bytes = new byte[buffer.readableBytes()];
        buffer.readBytes(bytes);

        try {
            DataInputStream inputStream = new DataInputStream(new ByteArrayInputStream(bytes));
            ItemStack itemStack = StreamSerializer.getDefault().deserializeItemStack(inputStream);
            if (itemStack == null){
                TimberNoCheat.checkmanager.notify(this, event.getPlayer(), " §6CHECK: §bNULLITEM", " §6KICK: §b" + !TimberNoCheat.instance.settings.exploit_nbt_nullcmd.equals(""));
                TimberNoCheat.checkmanager.execute(TimberNoCheat.instance.settings.exploit_nbt_nullcmd, event.getPlayer().getName());
                event.setCancelled(true);
                return;
            }
            NbtCompound root = (NbtCompound) NbtFactory.fromItemTag(itemStack);
            if (root == null) {
                TimberNoCheat.checkmanager.notify(this, event.getPlayer(), " §6CHECK: §bNONBTTAG", " §6KICK: §b" + !TimberNoCheat.instance.settings.exploit_nbt_nonbtdatacmd.equals(""));
                TimberNoCheat.checkmanager.execute(TimberNoCheat.instance.settings.exploit_nbt_nonbtdatacmd, event.getPlayer().getName());
                event.setCancelled(true);
                return;
            }
            if (!root.containsKey("pages")) {
                TimberNoCheat.checkmanager.notify(this, event.getPlayer(), " §6CHECK: §bNOPASGES", " §6KICK: §b" + !TimberNoCheat.instance.settings.exploit_nbt_nopagescmd.equals(""));
                TimberNoCheat.checkmanager.execute(TimberNoCheat.instance.settings.exploit_nbt_nopagescmd, event.getPlayer().getName());
                event.setCancelled(true);
                return;
            }
            NbtList<String> pages = root.getList("pages");
            if (root.getList("pages").size() > TimberNoCheat.instance.settings.exploit_nbt_toomanypages){
                TimberNoCheat.checkmanager.notify(this, event.getPlayer(), " §6CHECK: §bTOOMUCHPAGES", " §6KICK: §b" + !TimberNoCheat.instance.settings.exploit_nbt_toomanypagescmd.equals(""));
                TimberNoCheat.checkmanager.execute(TimberNoCheat.instance.settings.exploit_nbt_toomanypagescmd, event.getPlayer().getName());
                event.setCancelled(true);
                return;
            }
            if(TimberNoCheat.instance.settings.exploit_nbt_toolong == -1)
                return;
            for (String page : pages)
                if (page.length() > TimberNoCheat.instance.settings.exploit_nbt_toolong) {
                    TimberNoCheat.checkmanager.notify(this, event.getPlayer(), " §6CHECK: §bTOOLONGLENGHT", " §6KICK: §b" + !TimberNoCheat.instance.settings.exploit_nbt_toolongcmd.equals(""));
                    TimberNoCheat.checkmanager.execute(TimberNoCheat.instance.settings.exploit_nbt_toolongcmd, event.getPlayer().getName());
                    event.setCancelled(true);
                    return;
                }
        }catch (IOException e){
            e.printStackTrace();
        }finally {
            buffer.release();
        }
    }
}
