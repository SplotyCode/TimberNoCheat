package me.david.TimberNoCheat.checkes.exploits;

import com.comphenix.protocol.PacketType;
import com.comphenix.protocol.events.PacketAdapter;
import com.comphenix.protocol.events.PacketContainer;
import com.comphenix.protocol.events.PacketEvent;
import com.comphenix.protocol.utility.StreamSerializer;
import com.comphenix.protocol.wrappers.nbt.NbtCompound;
import com.comphenix.protocol.wrappers.nbt.NbtFactory;
import com.comphenix.protocol.wrappers.nbt.NbtList;
import io.netty.buffer.ByteBuf;
import me.david.TimberNoCheat.TimberNoCheat;
import me.david.TimberNoCheat.checkmanager.Category;
import me.david.TimberNoCheat.checkmanager.Check;
import org.bukkit.inventory.ItemStack;

import java.io.ByteArrayInputStream;
import java.io.DataInputStream;
import java.io.IOException;

public class NBT extends Check {

    private final boolean nonbt;
    private final boolean noitem;
    private final boolean nopages;
    private final int toomanypahes;
    private final int toolongtext;
    public NBT(){
        super("NBT", Category.EXPLOITS);
        nonbt = getBoolean("nonbt");
        noitem = getBoolean("noitem");
        nopages = getBoolean("nopages");
        toomanypahes = getInt("toomanypahes");
        toolongtext = getInt("toolongtext");
        TimberNoCheat.instance.protocolmanager.addPacketListener(new PacketAdapter(TimberNoCheat.instance, PacketType.Play.Client.CUSTOM_PAYLOAD) {
            @Override
            public void onPacketReceiving(PacketEvent event) {
                if(!TimberNoCheat.checkmanager.isvalid_create(event.getPlayer())){
                    return;
                }
                String name = event.getPacket().getStrings().readSafely(0);
                if(name.equals("REGISTER")){
                    Channels.check(event);
                }
                if (!"MC|BSign".equals(name) && !"MC|BEdit".equals(name))
                    return;
                check(event);
                Packet_Flood.check(event);
            }
        });
    }
    private void check(PacketEvent event){
        PacketContainer container = event.getPacket();
        ByteBuf buffer = container.getSpecificModifier(ByteBuf.class).read(0).copy();

        byte[] bytes = new byte[buffer.readableBytes()];
        buffer.readBytes(bytes);

        try {
            DataInputStream inputStream = new DataInputStream(new ByteArrayInputStream(bytes));
            ItemStack itemStack = StreamSerializer.getDefault().deserializeItemStack(inputStream);
            if (itemStack == null){
                if(!noitem)return;
                updatevio(this, event.getPlayer(), 1, " §6CHECK: §bNOITEM");
                event.setCancelled(true);
                return;
            }
            NbtCompound root = (NbtCompound) NbtFactory.fromItemTag(itemStack);
            if (root == null) {
                if(!nonbt)return;
                updatevio(this, event.getPlayer(), 1, " §6CHECK: §bNONBT");
                return;
            }
            if (!root.containsKey("pages")) {
                if(!nopages)return;
                updatevio(this, event.getPlayer(), 1, " §6CHECK: §bNOPASGES");
                event.setCancelled(true);
                return;
            }
            NbtList<String> pages = root.getList("pages");
            if (root.getList("pages").size() > toomanypahes && toomanypahes != -1){
                updatevio(this, event.getPlayer(), 1, " §6CHECK: §bTOOMUCHPAGES");
                event.setCancelled(true);
                return;
            }
            if(toolongtext == -1)
                return;
            for (String page : pages)
                if (page.length() > toolongtext) {
                    updatevio(this, event.getPlayer(), 1, " §6CHECK: §bTOOLONGLENGHT");
                    event.setCancelled(true);
                    return;
                }
        }catch (IOException e){
            e.printStackTrace();
        }finally {
            buffer.release();
        }
    }
}
